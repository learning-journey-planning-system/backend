# backend

<!-- ### 1. Shortcut to start the app:
1. Ensure MAMP/WAMP is on
2. Ensure you have pipenv installed
3. Run `pipenv shell`
4. Then `./start_backend.sh` -->

### 1. Setup: 
1. Clone backend repo
2. Ensure you are on backend directory and main branch 
3. Check that your python version is at least 3.9  
4. On MAMP/WAMP
5. edit connection string in `app/core/config.py` at `SQLALCHEMY_DATABASE_URI` (you can use sql alchemy to help you test your connection)
6. Use `pipenv` to run the app in virtual env -> its a better way to manage python applications and its requirements
```sh
pip install pipenv          # install pipenv
pipenv shell                # start a virtual env in the current dir
pipenv install --dev        # install all the specified dependencies
```

7. Continue with these codes
```sh
export PYTHONPATH=$PWD
python3 app/initial_data.py # initialise db first/ refresh it
```

8. Run the app (make sure you are in the `backend/` dir)
```sh
uvicorn app.main:app --reload
``` 

API documentation will be live @
Swagger: [127.0.0.1:8000/docs](127.0.0.1:8000/docs)  
Alternative: [127.0.0.1:8000/redoc](127.0.0.1:8000/redoc)

### 2. To stop the backend service and exit the pipenv shell
1. Stop backend service: ctrl + C
2. Exit pipenv shell: ctrl + D

### 3. Reference
[full-stack-fastapi-postgresql by tiangolo](https://github.com/tiangolo/full-stack-fastapi-postgresql)  
[his documentation](https://fastapi.tiangolo.com/)  
Used his implementation but simplified the app by docker, auth, celery and other unrequired utils.

### 4. Ground rules when developing new APIs
1. API Naming: 
- Use nouns instead of verbs in endpoint paths
- Use logical nesting on endpoints, just like how you organise your folders (eg. if you want to get skills for a course, the route should be `~/course/{course_id}/skills`)
2. Error Handling:
- try to think of the possible errors that might happen and handle it nicely
- eg. frontend passes a skill_id that does not exist, return a `skill does not exist`
3. API code logic
- try to use the crud base classes available already if can!
- if not create new crud methods with meaningful names
- when coding, if you find yourself writing almost the same code (eg. almost copy pasting), try to make new methods/ classes if need so that the code can be reused and we dont have too many lines of code
4. API definition and Description
- the function name will be the api definition
- and the notes in the `''''''` is the api Description. good to add the SC or issue tag it is related to so FE can reference better and know which api we developed for them

### 5. Folder structure explanation:

##### Overview:
```sh
.
├── app                         # The entire api module
│   ├── api                     # Api endpoints
│   ├── core                    # Methods for development (eg. settings)
│   ├── crud                    # Adds CRUD methods for each model
│   ├── db                      # Methods to manage database
│   ├── models                  # Description of the objects we need, SQLAlchemy maps these models
│   ├── schemas                 # Define input/return formats for apis
│   ├── tests                   # Unit tests (ignore for now)
│   ├── __init__.py             # Present in every folder to modularize the directories
│   ├── initial_data.py         # Script to connect to and initialise database
│   └── main.py                 # Runs the API application
└── .gitignore                  # Specifies files to be ignored by .git
└── Pipfile                     # Specifies requirements and dependencies for the app
└── Pipfile.lock                # Autogenerated cache by pipenv
└── README.md
```

##### All files (excludes explanation for test files)
```sh
.
├── app                         
│   ├── api                     
│   │   ├── api_v1              # apis are organised into versions (for ease of management in future releases)
│   │   │   ├── endpoints       
│   │   │   │   ├── __init__.py 
│   │   │   │   ├── roles.py    # all endpoints relating to one model is stored in one file
│   │   │   │   └── staffs.py   
│   │   │   ├── __init__.py     
│   │   │   └── api.py          # file to add endpoints to router
│   │   ├── __init__.py         
│   │   └── deps.py             # to create a database session for endpoints to retrieve data from
│   ├── core                    
│   │   ├── __init__.py         
│   │   └── config.py           # stores all settings variables
│   ├── crud                    
│   │   ├── __init__.py         
│   │   ├── base.py             # base model for all crud classes
│   │   ├── crud_role.py        # indiv crud class for each model 
│   │   └── crud_staff.py       # to add more specialised CRUD methods that are not in the base class
│   ├── db                      
│   │   ├── __init__.py         
│   │   ├── base_class.py       # base class for models
│   │   ├── base.py             # Import all the models, so that Base has them before being imported by Alembic
│   │   ├── init_db.py          # method to initialise db
│   │   └── session.py          # creates a session object
│   ├── models                  
│   │   ├── __init__.py         
│   │   ├── role.py             # each table will have its own class, one file for one table in the db
│   │   └── staff.py            
│   ├── schemas                 
│   │   ├── __init__.py         
│   │   ├── msg.py              # define format for error/success msgs
│   │   ├── role.py             # each model has its own file to define its input/return formats
│   │   └── staff.py            
│   ├── tests                   
│   ├── __init__.py             
│   ├── initial_data.py         
│   └── main.py                 
└── .gitignore                  
└── Pipfile                     
└── Pipfile.lock                
└── README.md                   
```
